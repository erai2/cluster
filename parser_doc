#streamlit_app.py
import os
import streamlit as st
from modules import case_parser
from modules.vector_manager import ingest_document, search_query
from modules.rag_search import answer_question
from modules.history_manager import log_qa, get_history
from modules.notion_sync import push_to_notion

# -------------------------------
# ê¸°ë³¸ ì„¸íŒ…
# -------------------------------
st.set_page_config(page_title="ğŸ“š ì² í•™/ëª…ë¦¬í•™ ì—°êµ¬ í”Œë«í¼", layout="wide")
DATA_DIR = "data"

if "docs" not in st.session_state:
    st.session_state.docs = []

# -------------------------------
# ì‚¬ì´ë“œë°” ë©”ë‰´
# -------------------------------
st.sidebar.title("ğŸ“Œ ë©”ë‰´")
page = st.sidebar.radio("ì´ë™", ["ë¬¸í—Œ ì—…ë¡œë“œ", "ì§ˆë¬¸/ë‹µë³€", "íˆìŠ¤í† ë¦¬", "ì‚¬ë¡€/ê·œì¹™ ì¶”ì¶œ", "Notion ì—°ë™"])

# -------------------------------
# 1) ë¬¸í—Œ ì—…ë¡œë“œ
# -------------------------------
if page == "ë¬¸í—Œ ì—…ë¡œë“œ":
    st.header("ğŸ“‚ ë¬¸í—Œ ì—…ë¡œë“œ (PDF/TXT/DOCX/MD/JSON/XLSX)")
    uploaded_files = st.file_uploader("ë¬¸í—Œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”", type=["pdf", "txt", "docx", "md", "json", "xlsx"], accept_multiple_files=True)

    if uploaded_files:
        for f in uploaded_files:
            file_path = os.path.join(DATA_DIR, "raw_texts", f.name)
            os.makedirs(os.path.dirname(file_path), exist_ok=True)
            with open(file_path, "wb") as out:
                out.write(f.read())
            st.session_state.docs.append(file_path)
        st.success(f"âœ… {len(uploaded_files)}ê°œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!")

        if st.button("ğŸ‘‰ ë²¡í„°DBì— ì €ì¥"):
            total_chunks = 0
            for path in st.session_state.docs:
                n_chunks = ingest_document(path)
                total_chunks += n_chunks
            st.success(f"âœ… ì´ {total_chunks}ê°œ ì²­í¬ ì €ì¥ ì™„ë£Œ (ë²¡í„°í™” ì™„ë£Œ)")

# -------------------------------
# 2) ì§ˆë¬¸/ë‹µë³€
# -------------------------------
elif page == "ì§ˆë¬¸/ë‹µë³€":
    st.header("ğŸ¤– AI ì§ˆì˜ì‘ë‹µ (RAG ê¸°ë°˜)")
    query = st.text_input("ê¶ê¸ˆí•œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:")

    if st.button("ì§ˆë¬¸í•˜ê¸°"):
        if not st.session_state.docs:
            st.warning("ë¨¼ì € ë¬¸í—Œì„ ì—…ë¡œë“œí•˜ì„¸ìš”.")
        else:
            answer = answer_question(query)
            st.markdown("### ğŸ“ ë‹µë³€")
            st.write(answer)

            log_qa(query, answer)
            st.success("âœ… íˆìŠ¤í† ë¦¬ì— ì €ì¥ë¨")

            if st.checkbox("Notionì—ë„ ì €ì¥"):
                push_to_notion(query, answer)
                st.info("ğŸ“¤ Notionì— ì €ì¥ ì™„ë£Œ!")

# -------------------------------
# 3) íˆìŠ¤í† ë¦¬
# -------------------------------
elif page == "íˆìŠ¤í† ë¦¬":
    st.header("ğŸ“œ ì§ˆë¬¸-ë‹µë³€ íˆìŠ¤í† ë¦¬")
    history = get_history()
    if not history:
        st.info("ì•„ì§ ì €ì¥ëœ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.")
    else:
        for i, item in enumerate(history[::-1], 1):
            st.markdown(f"**Q{i}: {item['q']}**")
            st.write(item['a'])
            st.markdown("---")

# -------------------------------
# 4) ì‚¬ë¡€/ê·œì¹™ ì¶”ì¶œ
# -------------------------------
elif page == "ì‚¬ë¡€/ê·œì¹™ ì¶”ì¶œ":
    st.header("ğŸ“˜ ì‚¬ë¡€/ê·œì¹™ ìë™ ì¶”ì¶œê¸°")
    if not st.session_state.docs:
        st.warning("ë¨¼ì € ë¬¸í—Œì„ ì—…ë¡œë“œí•˜ì„¸ìš”.")
    else:
        raw_text = ""
        for path in st.session_state.docs:
            try:
                with open(path, "r", encoding="utf-8") as f:
                    raw_text += f.read() + "\n"
            except:
                continue

        if st.button("ì‚¬ë¡€/ê·œì¹™ ì¶”ì¶œ ì‹¤í–‰"):
            cases = case_parser.parse_cases(raw_text)
            json_path, csv_path = case_parser.save_cases(cases)
            st.success(f"âœ… {len(cases)}ê°œ ì‚¬ë¡€/ê·œì¹™ ì¶”ì¶œ ì™„ë£Œ")

            st.download_button("ğŸ“¥ JSON ë‹¤ìš´ë¡œë“œ", open(json_path, "rb"), file_name="cases.json")
            st.download_button("ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ", open(csv_path, "rb"), file_name="cases.csv")

            st.subheader("ğŸ” ë¯¸ë¦¬ë³´ê¸°")
            for c in cases[:5]:
                st.json(c)

# -------------------------------
# 5) Notion ì—°ë™
# -------------------------------
elif page == "Notion ì—°ë™":
    st.header("ğŸ—„ï¸ Notion ì—°ë™ ê´€ë¦¬")
    st.write("í™˜ê²½ë³€ìˆ˜(`NOTION_TOKEN`, `NOTION_DB_ID`)ë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.")

    sample_q = "ì² í•™ì  í•©ì˜ ê°œë…ì€?"
    sample_a = "í•©ì˜ëŠ” ê°œì¸ ê°„ì˜ ì˜ê²¬ ì°¨ì´ë¥¼ ì¡°ìœ¨í•˜ì—¬ ê³µë™ ê²°ì •ì„ ë‚´ë¦¬ëŠ” ê³¼ì •ì´ë‹¤."

    if st.button("í…ŒìŠ¤íŠ¸ ë°ì´í„° ì „ì†¡"):
        push_to_notion(sample_q, sample_a)
        st.success("âœ… ìƒ˜í”Œ ë°ì´í„°ê°€ Notion DBì— ê¸°ë¡ë¨")
